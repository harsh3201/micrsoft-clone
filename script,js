const menuBtn = document.querySelector('.menu-btn');
const mainMenu = document.getElementById('mainMenu');
const nav = document.getElementById('mainNav');
const darkToggle = document.getElementById('darkToggle');
const body = document.body;

function toggleMenu() {
  menuBtn.classList.toggle('is-active');
  mainMenu.classList.toggle('show');
  const expanded = menuBtn.classList.contains('is-active');
  menuBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
}
menuBtn.addEventListener('click', toggleMenu);
menuBtn.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    toggleMenu();
  }
});

document.addEventListener('click', (e) => {
  const insideMenu = mainMenu.contains(e.target) || menuBtn.contains(e.target);
  if (!insideMenu && mainMenu.classList.contains('show')) {
    mainMenu.classList.remove('show');
    menuBtn.classList.remove('is-active');
  }
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    mainMenu.classList.remove('show');
    menuBtn.classList.remove('is-active');
  }
});

window.addEventListener('resize', () => {
  if (window.innerWidth > 700) {
    mainMenu.classList.remove('show');
    menuBtn.classList.remove('is-active');
  }
});

const DARK_KEY = 'site-dark-mode';
function applyDark(dark) {
  body.classList.toggle('dark', dark);
  darkToggle.setAttribute('aria-pressed', dark ? 'true' : 'false');
  const icon = darkToggle.querySelector('i');
  if (icon) icon.className = dark ? 'fas fa-sun' : 'fas fa-moon';
}
(function initDarkMode() {
  const preference = localStorage.getItem(DARK_KEY);
  const dark = preference === null ? (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) : preference === 'true';
  applyDark(dark);
})();
darkToggle.addEventListener('click', () => {
  const dark = !body.classList.contains('dark');
  applyDark(dark);
  localStorage.setItem(DARK_KEY, String(dark));
});

const STICKY_OFFSET = 48;
window.addEventListener('scroll', () => {
  if (window.scrollY > STICKY_OFFSET) nav.classList.add('sticky');
  else nav.classList.remove('sticky');
});

const revealElems = document.querySelectorAll('[data-reveal]');
const revealObserver = new IntersectionObserver((entries, obs) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      entry.target.classList.add('is-visible');
      obs.unobserve(entry.target);
    }
  });
}, { threshold: 0.12 });
revealElems.forEach(el => revealObserver.observe(el));

const lazyImages = document.querySelectorAll('img.lazy');
function setImgSrc(img) {
  const src = img.getAttribute('data-src');
  if (!src) return;
  img.src = src;
  img.removeAttribute('data-src');
  img.classList.remove('lazy');
}
if ('loading' in HTMLImageElement.prototype) {
  lazyImages.forEach(img => {
    img.setAttribute('loading', 'lazy');
    if (img.dataset && img.dataset.src) {
      img.src = img.dataset.src;
      img.removeAttribute('data-src');
      img.classList.remove('lazy');
    }
  });
} else {
  const lazyObserver = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        setImgSrc(entry.target);
        obs.unobserve(entry.target);
      }
    });
  }, { threshold: 0.1 });
  lazyImages.forEach(img => lazyObserver.observe(img));
}

document.querySelectorAll('a[href^="#"]').forEach(a => {
  a.addEventListener('click', (e) => {
    const href = a.getAttribute('href');
    if (href === '#' || href === '') return;
    const target = document.querySelector(href);
    if (target) {
      e.preventDefault();
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      mainMenu.classList.remove('show');
      menuBtn.classList.remove('is-active');
    }
  });
});

(function initCarousel() {
  const carousel = document.getElementById('carousel');
  if (!carousel) return;
  const slidesWrap = document.getElementById('slides');
  const slides = Array.from(slidesWrap.children);
  const prevBtn = carousel.querySelector('.carousel-btn.prev');
  const nextBtn = carousel.querySelector('.carousel-btn.next');
  const dotsContainer = document.getElementById('carouselDots');

  let current = 0;
  let isAnimating = false;
  let autoplayInterval = 4500;
  let timerId = null;
  let startX = 0;
  let deltaX = 0;

  slides.forEach((s, idx) => {
    const btn = document.createElement('button');
    btn.dataset.index = idx;
    btn.addEventListener('click', () => goTo(idx));
    dotsContainer.appendChild(btn);
  });
  const dots = Array.from(dotsContainer.children);

  function update() {
    const width = carousel.clientWidth;
    slidesWrap.style.transform = `translateX(-${current * width}px)`;
    dots.forEach((d, i) => d.classList.toggle('active', i === current));
  }

  window.addEventListener('resize', update);

  function goTo(idx) {
    if (isAnimating || idx === current) return;
    isAnimating = true;
    current = (idx + slides.length) % slides.length;
    update();
    setTimeout(() => isAnimating = false, 600);
    resetTimer();
  }

  function next() { goTo((current + 1) % slides.length); }
  function prev() { goTo((current - 1 + slides.length) % slides.length); }

  nextBtn.addEventListener('click', next);
  prevBtn.addEventListener('click', prev);

  carousel.addEventListener('touchstart', (e) => {
    startX = e.touches[0].clientX;
    deltaX = 0;
  }, { passive: true });

  carousel.addEventListener('touchmove', (e) => {
    if (!startX) return;
    deltaX = e.touches[0].clientX - startX;
  }, { passive: true });

  carousel.addEventListener('touchend', () => {
    if (Math.abs(deltaX) > 40) {
      if (deltaX < 0) next(); else prev();
    }
    startX = 0; deltaX = 0;
  });

  function startTimer() { timerId = setInterval(next, autoplayInterval); }
  function stopTimer() { if (timerId) { clearInterval(timerId); timerId = null; } }
  function resetTimer() { stopTimer(); startTimer(); }

  carousel.addEventListener('mouseenter', stopTimer);
  carousel.addEventListener('mouseleave', startTimer);
  carousel.addEventListener('focusin', stopTimer);
  carousel.addEventListener('focusout', startTimer);

  setTimeout(update, 50);
  startTimer();
})();

(function keyboardOutlineToggle() {
  function handleFirstTab(e) {
    if (e.key === 'Tab') {
      document.body.classList.add('user-is-tabbing');
      window.removeEventListener('keydown', handleFirstTab);
    }
  }
  window.addEventListener('keydown', handleFirstTab);
})();
